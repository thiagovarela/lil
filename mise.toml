[tasks.publish]
description = "Bump version and publish to npm (includes bundled web-ui)"
run = """
#!/usr/bin/env bash
set -euo pipefail

BUMP="${1:-patch}"

if [[ "$BUMP" != "patch" && "$BUMP" != "minor" && "$BUMP" != "major" ]]; then
  echo "Usage: mise run publish [patch|minor|major]"
  echo "Default: patch"
  exit 1
fi

# Ensure working directory is clean
if [[ -n "$(git status --porcelain)" ]]; then
  echo "Error: Working directory is not clean. Commit or stash changes first."
  exit 1
fi

# Build web-ui and copy to web-ui-dist/
echo "==> Building web-ui…"
bun run build:web-ui
echo "==> Web-ui bundled into web-ui-dist/"

# Bump version (updates package.json and creates git tag)
NEW_VERSION=$(npm version "$BUMP" --no-git-tag-version)
echo "Bumped to $NEW_VERSION"

# Commit and tag
git add package.json
git commit -m "release: $NEW_VERSION"
git tag "$NEW_VERSION"

# Publish to npm (web-ui-dist/ is included via "files" in package.json)
npm publish --access public

# Cleanup build artifact
rm -rf web-ui-dist

# Push commit and tag
git push && git push --tags

echo "✓ Published $NEW_VERSION (with bundled web-ui)"
"""

[tasks.release-web-ui]
description = "Build web-ui and publish to GitHub Releases"
run = """
#!/usr/bin/env bash
set -euo pipefail

VERSION="${1:-$(node -p "require('./package.json').version")}"
TAG="web-ui-v${VERSION}"
TARBALL="web-ui-${VERSION}.tar.gz"

echo "==> Releasing web-ui ${VERSION} (tag: ${TAG})"

# Ensure working directory is clean
if [[ -n "$(git status --porcelain)" ]]; then
  echo "Error: Working directory is not clean. Commit or stash changes first."
  exit 1
fi

# Install & build
echo "==> Installing web-ui dependencies…"
(cd web-ui && bun install --frozen-lockfile)

echo "==> Building web-ui…"
(cd web-ui && bun run build)

# Package
echo "==> Packaging .output → ${TARBALL}…"
tar -czf "${TARBALL}" -C web-ui .output

# Release
echo "==> Creating GitHub release ${TAG}…"
gh release create "${TAG}" "${TARBALL}" \
  --title "web-ui v${VERSION}" \
  --generate-notes

# Cleanup
rm -f "${TARBALL}"

echo "✓ Released web-ui v${VERSION} → https://github.com/thiagovarela/lil/releases/tag/${TAG}"
"""
